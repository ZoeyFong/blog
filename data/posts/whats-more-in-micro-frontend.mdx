---
title: å¾®å‰ç«¯ä¸­çš„éš”ç¦»é”™è¯¯ä¸ŠæŠ¥
date: '2025-05-14'
tags: ['å¾®å‰ç«¯', 'ç›‘æ§', 'Micro-Frontend', 'Infrastructure', 'Monitoring']
# keywords:
# ['å¾®å‰ç«¯', 'JavasSript', 'Frontend', 'Micro-Frontend', 'Infrastructure', 'Monitoring', 'ç›‘æ§']
draft: false
summary: å‰ç«¯å·¥ç¨‹åŒ–ä¸­å°‘ä¸äº†ç›‘æ§å‘Šè­¦ï¼Œå¯¹äºå¾®å‰ç«¯ä¹Ÿæ˜¯ä¸€æ ·ã€‚é‚£ä¹ˆå¯¹äºä¸€ä¸ªæˆç†Ÿçš„å¾®å‰ç«¯æ¡†æ¶ï¼Œå¦‚ä½•å¿«é€Ÿé›†æˆé”™è¯¯ä¸ŠæŠ¥èƒ½åŠ›ï¼Œå¹¶å®ç°å­åº”ç”¨çš„é”™è¯¯éš”ç¦»...
---

> å±…ç„¶æœ‰å¿«åŠå¹´æ²¡æ›´æ–°äº†... æœ€è¿‘å¯¹å¾®å‰ç«¯æ·±å…¥äº†è§£ï¼ˆåŠ ç­ï¼‰æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æƒ³é™†ç»­è¾“å‡ºä¸€äº›å›´ç»•å¾®å‰ç«¯çš„å°æƒ³æ³•ğŸ’¡ã€‚

# å¾®å‰ç«¯

å¾®å‰ç«¯æ˜¯ä»€ä¹ˆå°±ä¸èµ˜è¿°äº†ï¼Œä¸äº†è§£çš„å°ä¼™ä¼´å¯ä»¥çœ‹ä¸‹ [qiankun](https://qiankun.umijs.org/zh) çš„å®˜ç½‘ã€‚ä¸€å¥è¯è¯´ï¼Œæ˜¯é€šè¿‡ JS æ²™ç›’ä¿è¯å­åº”ç”¨â€œä¸€å®šç¨‹åº¦çš„â€ä¸å®¿ä¸»éš”ç¦»ï¼ŒåŒæ—¶å¯¹å‰ç«¯è¿è¡Œæ—¶æ¡†æ¶è¿›è¡Œå…¼å®¹ï¼Œä»è€Œä¾¿æ·åœ°åœ¨ä¸åŒå®¿ä¸»é—´å¤ç”¨ã€‚

ä¸€èˆ¬èŠåˆ°å¾®å‰ç«¯ï¼ŒåŸºæœ¬æ˜¯å› ä¸ºä¸€å¨å¤§å±å±±ï¼ˆæ¿€è¿›äº†ï¼Œå®¢è§‚çš„è¯´æ˜¯å·¨çŸ³åº”ç”¨ï¼‰çš„å¤æ‚åº¦ç†µå¢åˆ°ï¼Œç»´æŠ¤çš„å¿ƒæ™ºåœ¨ä¸šåŠ¡å¿«é€Ÿè¿­ä»£ä¸­æ— æ³•è¢«å¿½è§†äº†ã€‚é‚£ä¹ˆæˆ‘ä»¬é€‰æ‹©ï¼Œè®©å­åº”ç”¨ä½¿ç”¨**å¾®å‰ç«¯**çš„**åˆ†æ²»**æ€æƒ³è¿›è¡Œè¿­ä»£ï¼šç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ã€äº’ç›¸éš”ç¦»ã€æ¡†æ¶æ— å…³ï¼Œä»è€Œè§£å†³é«˜åº¦å¤æ‚çš„å•ä½“åº”ç”¨è¿­ä»£éš¾ã€ç»´æŠ¤éš¾çš„é—®é¢˜ã€‚

# é”™è¯¯ä¸ŠæŠ¥

å‰ç«¯å·¥ç¨‹åŒ–ä¸­å°‘ä¸äº†ç›‘æ§å‘Šè­¦ï¼Œå¯¹äºå¾®å‰ç«¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦é”™è¯¯ä¸ŠæŠ¥ã€ç›‘æ§å‘Šè­¦çš„èƒ½åŠ›ã€‚ä½†æ˜¯å¯¹å¾®å‰ç«¯æ¥è¯´ï¼ŒåŒºåˆ†é”™è¯¯â€œçœŸå®æ¥æºâ€å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚ä¸»ã€å­åº”ç”¨é—´æ··åˆä¸ŠæŠ¥ï¼Œæˆ–å­ã€å­åº”ç”¨äº’ç›¸æ±¡æŸ“ä¸ŠæŠ¥ï¼Œæºç å®šä½å¤±æ•ˆï¼Œåœ¨èŒ«èŒ«ç›‘æ§æ•°æ®ä¸­ï¼Œæ‰‹åŠ¨ ignore å’Œ filter çš„æˆæœ¬å¤ªé«˜ã€‚

ä¸šç•Œç›‘æ§å¤§ä½¬ [Sentry](https://docs.sentry.io/platforms/javascript/guides/astro/best-practices/micro-frontends/#automatically-route-errors-to-different-projects-depending-on-module) ç¡®å®ç»™å‡ºäº†å¾®å‰ç«¯ä¸ŠæŠ¥â€œè‡ªåŠ¨è·¯ç”±â€çš„å…·ä½“æ“ä½œæ–¹æ¡ˆï¼Œä½†å…·æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚æˆ‘ä»¬ç®€å•çœ‹ä¸‹å®˜ç½‘çš„ä»£ç ğŸŒ°, äº†è§£åŸºç¡€åŸç†ã€‚

å­åº”ç”¨æ‰“åŒ…æ—¶å¡«å…¥ metaï¼š

```javascript
// webpack.config.js
const { sentryWebpackPlugin } = require('@sentry/webpack-plugin')

module.exports = {
  devtool: 'source-map',
  plugins: [
    sentryWebpackPlugin({
      /* Other plugin config */
      _experiments: {
        moduleMetadata: ({ release }) => ({ dsn: '__MODULE_DSN__', release }),
      },
    }),
  ],
}
```

å®¿ä¸»ä¾§è¿è¡Œæ—¶æ ¹æ® meta åˆ¤æ–­æ¥æºï¼š

```javascript
const EXTRA_KEY = 'ROUTE_TO'

// çœç•¥ä¸€éƒ¨åˆ† transport ä»£ç ...

init({
  beforeSend: (event) => {
    if (event?.exception?.values?.[0].stacktrace.frames) {
      const frames = event.exception.values[0].stacktrace.frames
      // Find the last frame with module metadata containing a DSN
      const routeTo = frames
        .filter((frame) => frame.module_metadata && frame.module_metadata.dsn)
        .map((v) => v.module_metadata)
        .slice(-1) // using top frame only - you may want to customize this according to your needs

      if (routeTo.length) {
        event.extra = {
          ...event.extra,
          [EXTRA_KEY]: routeTo,
        }
      }
    }

    return event
  },
})
```

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæœ‰æ²¡æœ‰è§‰å¾—å¿ƒæ™ºè´Ÿæ‹…é™¡å¢ï¼Ÿ

1. å­åº”ç”¨ç¼–è¯‘æ—¶ã€å®¿ä¸»è¿è¡Œæ—¶éƒ½éœ€è¦å¯¹ meta è¿›è¡Œæ“ä½œï¼Œä¸€æ—¦æœ‰å˜åŠ¨è¿™åœ¨è·¨éƒ¨é—¨åä½œä¸­æ˜¯æ¯”è¾ƒè›‹ç–¼çš„ã€‚
2. å½“ä¸€ä¸ªç”Ÿäº§è€…å¯¼å‡ºè‹¥å¹²ä¸ªå¾®æ¨¡å—ï¼Œè€Œè¿™äº›å¾®æ¨¡å—æœ‰çš„å¸Œæœ›æ˜¯ç‹¬ç«‹çš„ç›‘æ§ï¼Œæœ‰äº›æ˜¯å¸Œæœ›èšåˆæŸ¥çœ‹ã€åŒæ—¶æ”¯æŒç­›é€‰çš„ï¼Œé‚£ä¹ˆå¯¹äºå¾®å‰ç«¯çš„ç›‘æ§é…ç½®å°†éå¸¸å¤æ‚ã€‚
3. æœ‰äº›å…¬å¸è‡ªå·±çš„ç›‘æ§è½®å­ï¼Œå¯èƒ½æ ¹æœ¬ä¸æ”¯æŒç±»ä¼¼ sentry çš„å¾®å‰ç«¯ auto routing èƒ½åŠ›ã€‚å¥½äº†ï¼Œé‚£æ–°çš„é€ è½®å­å¤§ä¸šåˆè¦å¼€å§‹äº†ã€‚

æ‰€ä»¥å¯¹äºä¸€ä¸ªæ‡‚äº‹çš„å¾®å‰ç«¯æ¡†æ¶ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è‡ªå·±è§£å†³è¿™å¥—é€»è¾‘ï¼Ÿ

## é”™è¯¯ä¸ŠæŠ¥çš„éš”ç¦»åˆ†å‘æ€è·¯

ä»ä¸Šé¢ sentry çš„ä¾‹å­ä¸éš¾çœ‹å‡ºï¼Œæ•´ä½“çš„æ€æƒ³æ˜¯ï¼Œä¸ºæ¯ä¸ªå­åº”ç”¨å¢åŠ ä¸€ä¸ª**æ ‡è¯†**ï¼Œè¿™ä¸ªæ ‡è¯†å°†ä¼šåœ¨å®¿ä¸»è¿è¡Œæ—¶è¢«æ¶ˆè´¹ã€‚é€šè¿‡åˆ†è¾¨æ ‡è¯†çš„æ¥æºï¼Œå®¿ä¸»ä¼šå°†é”™è¯¯åˆ†å‘åˆ°ä¸åŒçš„ç›‘æ§å®ä¾‹ï¼ˆæˆ– id ç­‰ä»»æ„ç›‘æ§æ§åˆ¶é¢å¯åˆ‡æ¢çš„ç»´åº¦ï¼‰ä¸­å»ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è‡ªå·±åœ¨å¾®å‰ç«¯æ¡†æ¶ä¸­å®ç°ï¼Œé‚£ä¹ˆæœ‰ä¸¤ä¸ªç»•ä¸å¼€çš„å…³é”®ç‚¹ï¼š

1. å­åº”ç”¨çš„æ ‡è¯†
2. é”™è¯¯åˆ†å‘

é€šå¸¸æ¥è¯´ï¼Œç¬¬ä¸€ç‚¹â€œå­åº”ç”¨çš„æ ‡è¯†â€å¯¹äºå¾®å‰ç«¯å±äºâ€œå¤©ç„¶å­˜åœ¨çš„â€ã€‚åœ¨å¾®å‰ç«¯æ¡†æ¶è®¾è®¡ä¸­ï¼Œä¸€ä¸ªå¾ˆçªå‡ºçš„ç‚¹æ˜¯`æ²™ç›’`ã€‚å¯ä»¥æ˜¯é€šè¿‡ Proxy, ä¹Ÿå¯ä»¥æ˜¯ä»»ä½•åˆ«çš„æŠ€æœ¯å®ç°çš„æ²™ç›’ã€‚æ²™ç›’å°±æ„å‘³ç€éš”ç¦»ã€äº’ä¸å¹²æ‰°ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸ªå­åº”ç”¨ä¸€å®šæœ‰`æ ‡è¯†`å­˜åœ¨ï¼Œä¸ç®¡æ˜¯é€šè¿‡è¿è¡Œæ—¶è¿˜æ˜¯ç¼–è¯‘æ—¶æ³¨å…¥ã€‚é‚£ä¹ˆå¯¹äºé”™è¯¯éš”ç¦»æ¥è¯´ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚é‚£ä¹ˆå°±åªéœ€è¦è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ â€”â€” é”™è¯¯åˆ†å‘ã€‚

## é”™è¯¯åˆ†å‘

é”™è¯¯ç›‘æ§çš„åŸç†æ˜¯ï¼šå¯¹ window çš„ `error` å’Œ `unhandledrejection` è¿›è¡Œç›‘å¬ã€å¤„ç†å’Œä¸ŠæŠ¥ã€‚æ‰€ä»¥å¾®å‰ç«¯è¿è¡Œæ—¶æ¡†æ¶è¦åšçš„ï¼Œå°±æ˜¯æœ€å…ˆæ³¨å†Œç›‘å¬äº‹ä»¶ï¼Œå¹¶è®¾ç½®åœ¨`æ•è·`é˜¶æ®µè¿›è¡Œå¤„ç†ã€‚ä¹‹æ‰€ä»¥å¼ºè°ƒ`æ•è·`, æ˜¯ä¸ºäº†æ›´æ—©åœ°æ•è·äº‹ä»¶ï¼Œä¸ºçˆ¶çº§å…ƒç´ èµ‹äºˆå¤„ç†äº‹ä»¶çš„èƒ½åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨å¾®å‰ç«¯é”™è¯¯ç›‘æ§åœºæ™¯ä¸‹ï¼Œä¾¿äºåœ¨å®¿ä¸»ä¾§è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚

æ‘¸æ¸…æ€è·¯åï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€æ®µä¼ªä»£ç ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šåœ¨è¿è¡Œæ¡†æ¶è‡ªèº«çš„é”™è¯¯åˆ†å‘é€»è¾‘åï¼Œè¦é˜»æ­¢é”™è¯¯äº‹ä»¶ fire å…¶ä»–ç›‘å¬å™¨ï¼Œé¿å…åŠŸäºä¸€ç¯‘ã€‚

```javascript
const getRoute = (e) => {
  // æ ¹æ®é”™è¯¯å †æ ˆï¼Œæ‹¿åˆ°é”™è¯¯è·¯å¾„
}

const listener = (e) => {
  let route = ''
  if (e.type === 'error') {
    route = getRoute(e.error)
  } else {
    route = getRoute(e.reason)
  }

  // åˆ¤æ–­è§¦å‘çš„è·¯å¾„æ˜¯å¦ç¬¦åˆ sandbox ä¸­çš„ä¸€äº›è·¯å¾„æ¡ä»¶
  if (route.match(/.../)) {
    // æ‰§è¡Œæ²™ç›’ä¸­å¯¹é”™è¯¯äº‹ä»¶çš„å›è°ƒï¼Œ
    sandbox.errorHandler(e)

    /**
     * @see å…³é”®ï¼
     * é˜»æ­¢è§¦å‘å…¶ä»–ä»»ä½•åœ¨ç›¸åŒå…ƒç´ æ³¨å†Œçš„ error æˆ– unhandledrejection äº‹ä»¶
     * åªæœ‰åŠ ä¸Šè¿™è¡Œï¼Œæ‰èƒ½ä¿è¯å…¶ä»–ç›‘æ§ SDK çš„ä¸ŠæŠ¥ä¸ä¼šèµ°åˆ°å…¶ä»–é”™è¯¯çš„å¾®å‰ç«¯æ¨¡å—æˆ–å®¿ä¸»
     */
    e.stopImmediatePropagation()
  }
}

root.addEventListener('error', listener, { capture: true })
root.addEventListener('unhandledrejection', listener, { capture: true })
```

ä¸Šé¢çš„ä»£ç åªæ˜¯æ¯”è¾ƒç²—ç•¥çš„æ¡†æ¶ï¼Œéœ€è¦å¤§å®¶ç»†å¿ƒå¡«è¡¥ï¼Œå¾®å‰ç«¯æ¡†æ¶ç™¾èŠ±é½æ”¾ï¼Œè¿™æ®µä¹Ÿåªèµ·ä¸€ä¸ªæ€è·¯å¯å‘çš„ä½œç”¨ã€‚

æ‰‹åŠ¨ğŸ¶å¤´ã€‚
