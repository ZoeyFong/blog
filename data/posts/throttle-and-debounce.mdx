---
title: æ‰‹å†™ debounce å’Œ throttle
date: '2023-11-25'
tags: ['JavaScript', 'Debounce', 'Throttle']
draft: false
---

# Debounce and Throttle

> Throttle æ˜¯ä¸ªä¸ä¼šè¢«æ‰“æ–­æ–½æ³•çš„ğŸ§™ğŸ¼â€â™‚ï¸æœ¯å£«ï¼ŒDebounce æ˜¯ä¸ªå°ğŸŒ¶ï¸ğŸ”, æ¯æ¬¡è¢«æ‰“æ–­éœ€è¦é‡æ–°è¯»æ¡

ä»å‘½åè§’åº¦å¾ˆå®¹æ˜“ç†è§£ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼Œ`Throttle` åœ¨ä¸€æ®µæ—¶é—´å†…åªä¼šæ‰§è¡Œä¸€æ¬¡è§¦å‘äº‹ä»¶çš„å›è°ƒï¼Œå…¶ä½™çš„å›è°ƒä¼šè¢«â€œèŠ‚æµâ€ã€‚`Debounce` é¡¾åæ€ä¹‰ de-bounce, å°†å¤šæ¬¡äº‹ä»¶ä¼˜åŒ–æˆæœ€åä¸€æ¬¡æ‰§è¡Œã€‚

ä¸¾ğŸŒ°ï¼š

- ç›‘å¬é¡µé¢æ»šåŠ¨äº‹ä»¶ï¼Œæ»šåŠ¨æ¡ä¸åœä¸Šä¸‹æ»šåŠ¨ï¼Œé€ æˆè¾ƒå¤§å¼€é”€ã€‚åº”è¯¥ä½¿ç”¨ï¼Ÿ â€”â€” Throttle, ä¸€æ®µæ—¶é—´å†…å¤šä½™çš„å›è°ƒåº”è¯¥ omit, å¹¶ä¸”å¸Œæœ›å¯¹ç”¨æˆ·è¡Œä¸ºä½œå‡ºåé¦ˆ
- ç›‘å¬æœç´¢æ¡†çš„æ–‡å­—å˜æ›´åè§¦å‘æ ¡éªŒï¼Œä¸åœæ›´æ”¹å†…å®¹ï¼Œå¯¼è‡´é¢‘ç¹æ ¡éªŒç”šè‡³å¡é¡¿ï¼Œåº”è¯¥ä½¿ç”¨ï¼Ÿ â€”â€” Debounce, åªå½“ x ms åä¸å˜æ›´æ–‡å­—æ—¶ï¼Œæ‰è¿›è¡Œâ€œæœ‰æ„ä¹‰â€çš„æ ¡éªŒ

---

# Debounce

å…ˆåˆ«æ€¥ï¼Œè¿™æ®µä»£ç ä»…ä»…æ˜¯æœ€åŸºç¡€çš„ï¼Œæ¥ä¸‹æ¥ä¼šç”¨ throttle äº†è§£è¿˜æœ‰ä»€ä¹ˆå¯æ·±å…¥çš„ã€‚

```js
const debounce = function (fn, delay = 300) {
  let timer = null
  return function () {
    const context = this
    const args = arguments

    timer && clearTimeout(timer)
    timer = setTimeout(() => {
      fn.apply(context, args)
    }, delay)
  }
}
```

---

# Throttle

## Basic Implementation

æŒ‰å‰é¢ debounce çš„æ€è·¯ï¼Œç›´æ¥å¤åˆ»ï¼Œä½†ä¸ä¼šæ‰“æ–­æ–½æ³•

```js
const basicThrottle = function (fn, delay = 0) {
  let timer = null
  return function () {
    if (timer) return // return immediately if the timer existed

    const context = this
    const args = arguments

    timer = setTimeout(() => {
      fn.apply(context, arguments)
      timer = null
    }, delay)
  }
}
```

## Throttle in Lodash

ä½†æ˜¯ä½¿ç”¨ `lodash` ä¼šå‘ç°ï¼Œ`throttle` è¿˜æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼š

- `options.leading=true` (boolean): invoking on the leading edge of the timeout
- `options.trailing=true` (boolean): invoking on the trailing edge of the timeout

* ä½¿ç”¨ throttle å‰:

  <img src="/static/images/before-throttle.webp" alt="before-throttle" />

* ä½¿ç”¨ default throttle `leading: true, trailing: true`

  <img src="/static/images/default-throttle.webp" alt="default-throttle" />

* é¦–èŠ‚æµ `leading: true, trailing: false`

  <img src="/static/images/leading-throttle.webp" alt="leading-throttle" />

* å°¾èŠ‚æµ `leading: false, trailing: true`ï¼ŒF æ¨è¿Ÿåˆ° 55 æ‰§è¡Œæ˜¯å› ä¸º delay äº†æœ€åä¸€ä¸ª 10

  <img src="/static/images/trailing-throttle.webp" alt="trailing-throttle" />

### ä¸Šé¢é‚£æ®µ `basicThrottle` å±äºé¦–èŠ‚æµè¿˜æ˜¯å°¾èŠ‚æµ

æŒ‰ç…§`lodash`çš„æ¦‚å¿µï¼Œä¸Šé¢çš„é‚£æ®µ`basicThrottle`æˆ‘ä»¬æ¥å½’ç±»ä¸€ä¸‹ã€‚çœ‹äº†ç½‘ä¸Šå¾ˆå¤šæ–‡ç« ï¼Œè¯´è®¡æ—¶å™¨ç‰ˆæœ¬çš„ä¸ºâ€œå°¾èŠ‚æµâ€ï¼Œå› ä¸ºé¦–æ¬¡çš„å›è°ƒæ²¡æœ‰æ‰§è¡Œã€‚

ä½†æ˜¯æˆ‘è®¤ä¸ºï¼Œå®ƒæ—¢ä¸æ˜¯é¦–èŠ‚æµä¹Ÿä¸æ˜¯å°¾èŠ‚æµ... å› ä¸ºï¼š

1. ä¸æ»¡è¶³é¦–èŠ‚æµçš„é¦–æ¬¡ç«‹å³æ‰§è¡Œ
2. æœ€åä¸€ä¸ªå›è°ƒä¸ä¼šç­‰å¾… delay åæœ€ç»ˆæ‰§è¡Œ

å¦‚æœç¡¬è¦å½’ç±»ï¼Œåº”è¯¥æ˜¯éç«‹å³æ‰§è¡Œç‰ˆçš„é¦–èŠ‚æµã€‚å°½ç®¡ç¬¬ä¸€æ¬¡çš„å›è°ƒä¼šè§¦å‘ï¼Œä½†æ˜¯åœ¨ `delay` åï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œã€‚

ä¸ºäº†éªŒè¯ï¼Œæˆ‘ä»¬å†™ä¸ªæµ‹è¯•:

```
// Console
a = basicThrottle(console.debug, 1000)
[a(1), a(2), a(3)] // 1s å log 1
```

## Throttle with Options

å®ç°ä¸€ä¸ªç¬¦åˆ lodash throttle å‡½æ•°ç­¾åçš„èŠ‚æµå‡½æ•°

```js
const throttle = function (fn, delay = 0, options = {}) {
  const { leading = true, trailing = true } = options
  let timer = null
  let lastContext = null
  let lastArgs = null

  const later = () => {
    if (trailing) {
      fn.apply(lastContext, lastArgs)
      lastContext = null
      lastArgs = null
      timer = setTimeout(later, delay)
    } else {
      timer = null
    }
  }

  return function () {
    /**
     * store the current context and arguments for the execution after the delay
     * each time the function called with a timer existed, these two would be updated
     */
    lastContext = this
    lastArgs = arguments

    if (timer) return

    // execute the function immediately when no timer exists [leading = true]
    if (leading) {
      fn.apply(this, arguments)
    }

    timer = setTimeout(later, delay)
  }
}
```

å†è·‘ä¸€ä¸‹éªŒè¯ï¼Œçœ‹çœ‹æ˜¯å¦ä¸`lodash`æ¦‚å¿µç›¸ç¬¦ï¼š

```
// Console
a = throttle (console.debug, 1000, {leading:false})
[a(1), a(2), a(3)] // 1s å log 3

a = throttle (console.debug, 1000, {trailing:false})
[a(1), a(2), a(3)] // 1s å log 1

a = throttle (console.debug, 1000, {trailing:false, leading:false})
[a(1), a(2), a(3)] // æ—  log
```

## rAFThrottle

é˜…è¯» `lodash` æºç ä¼šå‘ç°ï¼Œé‡Œé¢ä½¿ç”¨äº† `requestAnimationFrame` ï¼ˆåé¢ç®€ç§° RAFï¼‰ã€‚

```
 * If `wait` is omitted in an environment with `requestAnimationFrame`, `func`
 * invocation will be deferred until the next frame is drawn (typically about
 * 16ms).
```

### ä»€ä¹ˆæ˜¯ RAF

`window.requestAnimationFrame()` å‘Šè¯‰æµè§ˆå™¨â€”â€”ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œå¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œã€‚

### å¦‚ä½•ä½¿ç”¨ RAF å†™ä¸€ä¸ª `rAFThrottle`

å†™ä¹‹å‰æ˜ç¡®è¿™ä¸ªèŠ‚æµå‡½æ•°å¯ä»¥åšä»€ä¹ˆ â€”â€” `rAFThrottle` æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä½†ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œç›´åˆ°æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜å‰ã€‚

```js
const rAFThrottle = (fn) => {
  let reqId
  let args

  const later = (context) => () => {
    fn.apply(context, args)
  }

  return function () {
    if (reqId) cancelAnimationFrame(reqId)
    args = arguments
    reqId = requestAnimationFrame(later(this))
  }
}
```

BTW, è¿™æ˜¯ä¸ªå°¾èŠ‚æµã€‚

---

# Reference

- [Throttle & Debounce behavior (lodash)](https://ellenaua.medium.com/throttle-debounce-behavior-lodash-6bcae1494e03)
- [Write a better throttle function with Underscore](https://gist.github.com/pinglu85/fbe672cb84faa987a1e97e20d844b108)
